<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="A retry “budget” for allowing only a certain amount of retries over time."><meta name="keywords" content="rust, rustlang, rust-lang, budget"><title>tower::retry::budget - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../../../normalize.css"><link rel="stylesheet" type="text/css" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../../../dark.css" disabled><link rel="stylesheet" type="text/css" href="../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../storage.js"></script><script defer src="../../../main.js"></script><noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../tower/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../../tower/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"><a href="#">Module budget</a></h2><div class="sidebar-elems"><section><div class="block"><ul><li><a href="#structs">Structs</a></li></ul></div></section></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../../tower/index.html"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn"><span class="in-band">Module <a href="../../index.html">tower</a>::<wbr><a href="../index.html">retry</a>::<wbr><a class="mod" href="#">budget</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../../../src/tower/retry/budget.rs.html#1-348">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><span class="item-info"><div class="stab portability">Available on <strong>crate feature <code>retry</code></strong> only.</div></span><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>A retry “budget” for allowing only a certain amount of retries over time.</p>
<h2 id="why-budgets-and-not-max-retries"><a href="#why-budgets-and-not-max-retries">Why budgets and not max retries?</a></h2>
<p>The most common way of configuring retries is to specify a maximum
number of retry attempts to perform before giving up. This is a familiar idea to anyone
who’s used a web browser: you try to load a webpage, and if it doesn’t load, you try again.
If it still doesn’t load, you try a third time. Finally you give up.</p>
<p>Unfortunately, there are at least two problems with configuring retries this way:</p>
<p><strong>Choosing the maximum number of retry attempts is a guessing game.</strong>
You need to pick a number that’s high enough to make a difference when things are somewhat failing,
but not so high that it generates extra load on the system when it’s really failing. In practice,
you usually pick a maximum retry attempts number out of a hat (e.g. 3) and hope for the best.</p>
<p><strong>Systems configured this way are vulnerable to retry storms.</strong>
A retry storm begins when one service starts to experience a larger than normal failure rate.
This causes its clients to retry those failed requests. The extra load from the retries causes the
service to slow down further and fail more requests, triggering more retries. If each client is
configured to retry up to 3 times, this can quadruple the number of requests being sent! To make
matters even worse, if any of the clients’ clients are configured with retries, the number of retries
compounds multiplicatively and can turn a small number of errors into a self-inflicted denial of service attack.</p>
<p>It’s generally dangerous to implement retries without some limiting factor. <a href="struct.Budget.html" title="Budget"><code>Budget</code></a>s are that limit.</p>
<h2 id="examples"><a href="#examples">Examples</a></h2>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">std::sync::Arc</span>;

<span class="kw">use</span> <span class="ident">futures_util::future</span>;
<span class="kw">use</span> <span class="ident">tower::retry</span>::{<span class="ident">budget::Budget</span>, <span class="ident">Policy</span>};

<span class="kw">type</span> <span class="ident">Req</span> <span class="op">=</span> <span class="ident">String</span>;
<span class="kw">type</span> <span class="ident">Res</span> <span class="op">=</span> <span class="ident">String</span>;

<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Clone</span>, <span class="ident">Debug</span>)]</span>
<span class="kw">struct</span> <span class="ident">RetryPolicy</span> {
    <span class="ident">budget</span>: <span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">Budget</span><span class="op">&gt;</span>,
}

<span class="kw">impl</span><span class="op">&lt;</span><span class="ident">E</span><span class="op">&gt;</span> <span class="ident">Policy</span><span class="op">&lt;</span><span class="ident">Req</span>, <span class="ident">Res</span>, <span class="ident">E</span><span class="op">&gt;</span> <span class="kw">for</span> <span class="ident">RetryPolicy</span> {
    <span class="kw">type</span> <span class="ident">Future</span> <span class="op">=</span> <span class="ident">future::Ready</span><span class="op">&lt;</span><span class="self">Self</span><span class="op">&gt;</span>;

    <span class="kw">fn</span> <span class="ident">retry</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">req</span>: <span class="kw-2">&amp;mut</span> <span class="ident">Req</span>, <span class="ident">result</span>: <span class="kw-2">&amp;mut</span> <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">Res</span>, <span class="ident">E</span><span class="op">&gt;</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident"><span class="self">Self</span>::Future</span><span class="op">&gt;</span> {
        <span class="kw">match</span> <span class="ident">result</span> {
            <span class="prelude-val">Ok</span>(<span class="kw">_</span>) =&gt; {
                <span class="comment">// Treat all `Response`s as success,</span>
                <span class="comment">// so deposit budget and don&#39;t retry...</span>
                <span class="self">self</span>.<span class="ident">budget</span>.<span class="ident">deposit</span>();
                <span class="prelude-val">None</span>
            }
            <span class="prelude-val">Err</span>(<span class="kw">_</span>) =&gt; {
                <span class="comment">// Treat all errors as failures...</span>
                <span class="comment">// Withdraw the budget, don&#39;t retry if we overdrew.</span>
                <span class="kw">let</span> <span class="ident">withdrew</span> <span class="op">=</span> <span class="self">self</span>.<span class="ident">budget</span>.<span class="ident">withdraw</span>().<span class="ident">is_ok</span>();
                <span class="kw">if</span> <span class="op">!</span><span class="ident">withdrew</span> {
                    <span class="kw">return</span> <span class="prelude-val">None</span>;
                }

                <span class="comment">// Try again!</span>
                <span class="prelude-val">Some</span>(<span class="ident">future::ready</span>(<span class="self">self</span>.<span class="ident">clone</span>()))
            }
        }
    }

    <span class="kw">fn</span> <span class="ident">clone_request</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">req</span>: <span class="kw-2">&amp;</span><span class="ident">Req</span>) -&gt; <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">Req</span><span class="op">&gt;</span> {
        <span class="prelude-val">Some</span>(<span class="ident">req</span>.<span class="ident">clone</span>())
    }
}</code></pre></div>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Budget.html" title="tower::retry::budget::Budget struct">Budget</a></div><div class="item-right docblock-short"><p>Represents a “budget” for retrying requests.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Overdrawn.html" title="tower::retry::budget::Overdrawn struct">Overdrawn</a></div><div class="item-right docblock-short"><p>Indicates that it is not currently allowed to “withdraw” another retry
from the <a href="struct.Budget.html" title="Budget"><code>Budget</code></a>.</p>
</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="tower" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0-nightly (29e4a9ee0 2022-08-10)" ></div></body></html>